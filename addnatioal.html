<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>有理數加法練習</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-96 text-center">
    <h1 class="text-2xl font-bold mb-4">有理數加法練習</h1>

    <!-- 題目 -->
    <div id="question" class="text-xl font-semibold mb-4">? + ? =</div>

    <!-- 輸入答案 -->
    <input id="answer" type="text" 
           class="border rounded p-2 w-full mb-4 text-center text-lg" 
           placeholder="分數請用 a/b 或整數">

    <!-- 按鈕區 -->
    <div class="flex gap-2">
      <button onclick="checkAnswer()" 
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1">
        檢查
      </button>
      <button onclick="newQuestion()" 
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex-1">
        下一題
      </button>
    </div>

    <!-- 回饋訊息 -->
    <div id="feedback" class="mt-4 text-lg"></div>

    <!-- 計分 & 限時 -->
    <div class="mt-6 flex justify-between text-lg font-semibold">
      <div>分數：<span id="score">0</span></div>
      <div>題數：<span id="questions">0</span></div>
      <div>時間：<span id="time">60</span>s</div>
    </div>
  </div>

  <script>
    let num1, den1, num2, den2;
    let score = 0, total = 0, timeLeft = 60, timer;

    function gcd(a, b) {
      return b ? gcd(b, a % b) : Math.abs(a);
    }

    function simplify(n, d) {
      const g = gcd(n, d);
      n /= g; d /= g;
      if (d < 0) { n = -n; d = -d; }
      return [n, d];
    }

    function randomFraction() {
      let n = Math.floor(Math.random() * 9) + 1; // 1~9
      let d = Math.floor(Math.random() * 9) + 1; // 1~9
      if (Math.random() < 0.5) n *= -1;
      return simplify(n, d);
    }

    function fractionToString(n, d) {
      return d === 1 ? `${n}` : `${n}/${d}`;
    }

    function newQuestion() {
      [num1, den1] = randomFraction();
      [num2, den2] = randomFraction();
      document.getElementById("question").textContent = 
        `${fractionToString(num1, den1)} + ${fractionToString(num2, den2)} = ?`;
      document.getElementById("answer").value = "";
      document.getElementById("feedback").textContent = "";
    }

    function parseFraction(str) {
      if (str.includes("/")) {
        let [n, d] = str.split("/").map(Number);
        return simplify(n, d);
      } else {
        return [parseInt(str), 1];
      }
    }

    function checkAnswer() {
      const [sumNum, sumDen] = simplify(num1 * den2 + num2 * den1, den1 * den2);
      let userStr = document.getElementById("answer").value.trim();
      try {
        const [userNum, userDen] = parseFraction(userStr);
        total++;
        document.getElementById("questions").textContent = total;
        if (userNum === sumNum && userDen === sumDen) {
          score++;
          document.getElementById("feedback").textContent = "✅ 正確！";
          document.getElementById("feedback").className = "mt-4 text-lg text-green-600";
        } else {
          document.getElementById("feedback").textContent = `❌ 錯了，正確答案是 ${fractionToString(sumNum, sumDen)}`;
          document.getElementById("feedback").className = "mt-4 text-lg text-red-600";
        }
        document.getElementById("score").textContent = score;
      } catch {
        document.getElementById("feedback").textContent = "⚠️ 輸入格式錯誤";
        document.getElementById("feedback").className = "mt-4 text-lg text-yellow-600";
      }
    }

    function startTimer() {
      clearInterval(timer);
      timeLeft = 60;
      document.getElementById("time").textContent = timeLeft;
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById("time").textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timer);
          alert(`時間到！你的得分：${score} / ${total}`);
        }
      }, 1000);
    }

    // 初始啟動
    newQuestion();
    startTimer();

    // PWA 註冊
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
